{% extends 'main/base.html' %}
{% load market_tags %}

{% block title %}PolyEYE - {{ market.slug }}{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <div class="bg-white rounded-[48px] p-8 md:p-12 min-h-[600px] border border-black">

        <!-- Header with Breadcrumb -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
            <div>
                <div class="flex items-center gap-2 mb-4">
                    <a href="{% url 'market:files_list' %}"
                       class="text-sm text-gray-400 hover:text-black transition-colors uppercase tracking-wider">
                        View Files
                    </a>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    <span class="text-sm text-black uppercase tracking-wider">{{ market.slug }}</span>
                </div>
                <h2 class="text-4xl md:text-5xl font-thin uppercase tracking-tighter leading-[0.9] text-black">
                    {{ market.slug }}
                </h2>
                <p class="mt-4 text-lg text-gray-500 font-light">
                    {{ total_count }} ticks &middot; Created {{ market.created_at|date:"M d, Y H:i" }}
                </p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'market:files_list' %}"
                   class="px-6 py-3 rounded-full font-light uppercase tracking-wider text-sm
                          border border-black hover:bg-gray-50 transition-all flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Back
                </a>
            </div>
        </div>

        <!-- Timestamp Filter -->
        <div class="mb-8">
            <form method="GET" class="flex gap-4 max-w-md">
                <div class="flex-1 relative">
                    <i data-lucide="clock" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" name="timestamp" value="{{ timestamp_filter }}"
                           placeholder="Filter by timestamp_ms..."
                           class="w-full bg-transparent border border-black rounded-full pl-12 pr-6 py-3
                                  text-black font-light placeholder-gray-400 focus:outline-none focus:bg-white transition-all">
                </div>
                <button type="submit"
                        class="px-6 py-3 rounded-full bg-black text-white font-light uppercase
                               tracking-wider text-sm hover:opacity-90 transition-colors">
                    Filter
                </button>
                {% if timestamp_filter %}
                <a href="{% url 'market:file_detail' market.slug %}"
                   class="px-6 py-3 rounded-full border border-black font-light uppercase
                          tracking-wider text-sm hover:bg-gray-50 transition-colors">
                    Clear
                </a>
                {% endif %}
            </form>
        </div>

        <!-- Data Table -->
        <div class="overflow-x-auto border border-gray-200 rounded-[24px]">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        {% for field in tick_fields %}
                        <th class="text-left py-3 px-4 text-xs font-medium uppercase tracking-wider text-gray-500 whitespace-nowrap border-b border-gray-200">
                            {{ field }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for tick in page_obj %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        {% for field in tick_fields %}
                        <td class="py-3 px-4 text-gray-700 whitespace-nowrap font-mono text-xs">
                            {% with value=tick|getattribute:field %}
                                {% if value is None %}
                                    <span class="text-gray-300">-</span>
                                {% elif field == 'up_bids' or field == 'up_asks' or field == 'down_bids' or field == 'down_asks' %}
                                    <span class="text-gray-400">[{{ value|length }} levels]</span>
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ tick_fields|length }}" class="py-12 text-center text-gray-400">
                            No ticks found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="flex items-center justify-between mt-8 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-500">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
            </p>
            <div class="flex gap-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if timestamp_filter %}&timestamp={{ timestamp_filter }}{% endif %}"
                   class="w-10 h-10 rounded-full border border-black flex items-center justify-center
                          hover:bg-black hover:text-white transition-colors">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </a>
                {% endif %}

                <span class="px-4 py-2 text-sm text-gray-500">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if timestamp_filter %}&timestamp={{ timestamp_filter }}{% endif %}"
                   class="w-10 h-10 rounded-full border border-black flex items-center justify-center
                          hover:bg-black hover:text-white transition-colors">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
