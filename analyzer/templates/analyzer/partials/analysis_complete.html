<!-- Total PnL Summary -->
<div
    class="bg-black rounded-[48px] p-10 md:p-14 text-white mb-12 relative overflow-hidden border border-black shadow-2xl">
    <div class="absolute top-0 right-0 p-12 opacity-5">
        <i data-lucide="activity" width="160"></i>
    </div>
    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-12">
        <div class="text-center md:text-left">
            <span class="text-gray-400 uppercase tracking-widest text-xs font-light mb-3 block">Current Net Profit /
                Loss</span>
            <div
                class="text-7xl md:text-9xl font-thin tracking-tighter {% if metrics.current_pnl >= 0 %}text-white{% else %}text-red-400{% endif %}">
                ${{ metrics.current_pnl|floatformat:2 }}
                <span class="text-3xl md:text-5xl opacity-40 ml-4">{{ metrics.current_pnl_pct|floatformat:1 }}%</span>
            </div>
            <div class="mt-8 flex justify-center md:justify-start gap-10">
                <div>
                    <div class="text-gray-500 text-[10px] uppercase tracking-wider mb-1 font-light">Current Value</div>
                    <div class="text-2xl font-light font-mono text-white">${{ metrics.current_value|floatformat:2 }}
                    </div>
                </div>
                <div>
                    <div class="text-gray-500 text-[10px] uppercase tracking-wider mb-1 font-light">Total Cost</div>
                    <div class="text-2xl font-light font-mono text-white">${{ metrics.total_spent|floatformat:2 }}</div>
                </div>
            </div>
        </div>
        <div class="bg-white/5 backdrop-blur-md rounded-3xl p-8 border border-white/10 w-full md:w-auto min-w-[240px]">
            <div class="space-y-6">
                <div>
                    <span class="text-gray-500 text-[10px] uppercase tracking-widest block mb-1">Exposure</span>
                    <div class="flex items-center gap-3">
                        <div class="h-2 w-2 rounded-full bg-green-500"></div>
                        <span class="text-sm font-light text-white">{{ metrics.remaining_yes|floatformat:2 }} YES
                            Shares</span>
                    </div>
                    <div class="flex items-center gap-3 mt-2">
                        <div class="h-2 w-2 rounded-full bg-red-500"></div>
                        <span class="text-sm font-light text-white">{{ metrics.remaining_no|floatformat:2 }} NO
                            Shares</span>
                    </div>
                </div>
                <div class="pt-4 border-t border-white/10">
                    <span class="text-gray-500 text-[10px] uppercase tracking-widest block mb-1">Trade Count</span>
                    <span class="text-sm font-light text-white">{{ metrics.trade_count }} TOTAL TRADES</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dual KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
    <!-- YES Scenario -->
    <div class="bg-white rounded-[40px] p-8 md:p-10 text-black relative overflow-hidden border border-black group">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="text-3xl font-thin tracking-tight">Outcome: YES</h3>
            </div>
            {% if resolved_side == "YES" %}
            <div class="px-5 py-2 bg-black rounded-xl flex items-center justify-center">
                <span class="text-sm font-bold text-white tracking-widest uppercase">WIN!</span>
            </div>
            {% endif %}
        </div>

        <div class="mb-6">
            <span class="text-gray-400 uppercase tracking-widest text-[10px] font-light mb-1 block">Estimated ROI</span>
            <div
                class="text-5xl md:text-6xl font-thin tracking-tighter {% if metrics.pnl_yes >= 0 %}text-black{% else %}text-red-500{% endif %}">
                {{ metrics.pnl_yes_pct|floatformat:1 }}%
            </div>
            <div class="text-sm font-light text-gray-400 mt-2">
                ${{ metrics.pnl_yes|floatformat:2 }} absolute PnL
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 border-t border-black/5 pt-6">
            <div>
                <div class="text-gray-400 text-[10px] uppercase tracking-wider mb-1 font-light">Final Value</div>
                <div class="text-lg font-light font-mono">${{ metrics.final_value_yes|floatformat:2 }}</div>
            </div>
            <div>
                <div class="text-gray-400 text-[10px] uppercase tracking-wider mb-1 font-light">Total Spent</div>
                <div class="text-lg font-light font-mono">${{ metrics.total_spent|floatformat:2 }}</div>
            </div>
        </div>
    </div>

    <!-- NO Scenario -->
    <div class="bg-white rounded-[40px] p-8 md:p-10 text-black relative overflow-hidden border border-black group">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="text-3xl font-thin tracking-tight">Outcome: NO</h3>
            </div>
            {% if resolved_side == "NO" %}
            <div class="px-5 py-2 bg-black rounded-xl flex items-center justify-center">
                <span class="text-sm font-bold text-white tracking-widest uppercase">WIN!</span>
            </div>
            {% endif %}
        </div>

        <div class="mb-6">
            <span class="text-gray-400 uppercase tracking-widest text-[10px] font-light mb-1 block">Estimated ROI</span>
            <div
                class="text-5xl md:text-6xl font-thin tracking-tighter {% if metrics.pnl_no >= 0 %}text-black{% else %}text-red-500{% endif %}">
                {{ metrics.pnl_no_pct|floatformat:1 }}%
            </div>
            <div class="text-sm font-light text-gray-400 mt-2">
                ${{ metrics.pnl_no|floatformat:2 }} absolute PnL
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 border-t border-black/5 pt-6">
            <div>
                <div class="text-gray-400 text-[10px] uppercase tracking-wider mb-1 font-light">Final Value</div>
                <div class="text-lg font-light font-mono">${{ metrics.final_value_no|floatformat:2 }}</div>
            </div>
            <div>
                <div class="text-gray-400 text-[10px] uppercase tracking-wider mb-1 font-light">Total Spent</div>
                <div class="text-lg font-light font-mono">${{ metrics.total_spent|floatformat:2 }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Metrics Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Chart Card -->
    <div class="bg-white rounded-[32px] p-8 border border-black h-[400px] flex flex-col">
        <h3 class="text-sm font-light tracking-widest uppercase text-gray-500 mb-6">Position Analysis</h3>
        <a href="{% url 'analyzer:view_chart' %}" target="_blank"
            class="flex-1 w-full h-full flex items-center justify-center bg-gray-50 rounded-2xl overflow-hidden relative group/chart">
            <img src="{% url 'analyzer:view_chart' %}" alt="Trade Analysis Chart"
                class="w-full h-full object-cover opacity-90 mix-blend-multiply transition-transform duration-500 group-hover/chart:scale-110">
            <div
                class="absolute inset-0 bg-black/0 group-hover/chart:bg-black/5 transition-colors flex items-center justify-center opacity-0 group-hover/chart:opacity-100">
                <i data-lucide="maximize-2" class="text-black" width="24"></i>
            </div>
        </a>
    </div>

    <!-- Volume Cards -->
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-[32px] p-8 border border-black flex flex-col justify-center">
            <h3 class="text-sm font-light tracking-widest uppercase text-gray-500 mb-6">YES Volume</h3>
            <div class="text-3xl font-thin text-black mb-1">
                {{ metrics.yes_buy_sh|add:metrics.yes_sell_sh|floatformat:2 }}
            </div>
            <div class="text-xs text-gray-400 font-mono font-light">SHARES TRADED</div>
        </div>

        <div class="bg-white rounded-[32px] p-8 border border-black flex flex-col justify-center">
            <h3 class="text-sm font-light tracking-widest uppercase text-gray-500 mb-6">NO Volume</h3>
            <div class="text-3xl font-thin text-black mb-1">
                {{ metrics.no_buy_sh|add:metrics.no_sell_sh|floatformat:2 }}
            </div>
            <div class="text-xs text-gray-400 font-mono font-light">SHARES TRADED</div>
        </div>

        <div class="bg-white rounded-[32px] p-8 border border-black flex flex-col justify-center">
            <h3 class="text-sm font-light tracking-widest uppercase text-gray-500 mb-6">Remaining YES</h3>
            <div class="text-3xl font-thin text-black mb-1">{{ metrics.remaining_yes|floatformat:2 }}</div>
            <div class="text-xs text-gray-400 font-mono font-light">HELD AT CLOSE</div>
        </div>

        <div class="bg-white rounded-[32px] p-8 border border-black flex flex-col justify-center">
            <h3 class="text-sm font-light tracking-widest uppercase text-gray-500 mb-6">Remaining NO</h3>
            <div class="text-3xl font-thin text-black mb-1">{{ metrics.remaining_no|floatformat:2 }}</div>
            <div class="text-xs text-gray-400 font-mono font-light">HELD AT CLOSE</div>
        </div>
    </div>
</div>

<div class="flex justify-center">
    <a href="{% url 'analyzer:download_report' %}" download class="no-underline">
        <button
            class="px-8 py-4 rounded-full font-light uppercase tracking-wider transition-all duration-300 flex items-center justify-center gap-2 bg-white text-black border border-black hover:bg-black hover:text-white">
            <i data-lucide="download" width="18"></i>
            Download Text Report
        </button>
    </a>
</div>

<!-- Interactive Trade Chart Section -->
<div class="mt-16 pt-16 border-t border-black/5">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h3 class="text-3xl font-thin tracking-tight text-black">Interactive Timeline</h3>
            <p class="text-gray-400 text-sm font-light mt-1 uppercase tracking-wider">Execution Points & Price Action
            </p>
        </div>
    </div>

    <div id="chart-container"
        class="bg-white rounded-[40px] border border-black overflow-hidden relative transition-all duration-500 ease-in-out group/container">
        <!-- Chart Controls -->
        <div class="absolute top-6 right-6 z-[100] flex items-center gap-4">
            <!-- Fullscreen Toggle -->
            <button onclick="toggleFullscreen()" id="fullscreen-btn"
                class="p-2 rounded-xl border border-black/5 bg-gray-100 text-gray-500 hover:text-black hover:bg-white transition-all"
                title="Toggle Fullscreen">
                <i data-lucide="maximize-2" class="w-5 h-5" id="maximize-icon"></i>
                <i data-lucide="minimize-2" class="w-5 h-5 hidden" id="minimize-icon"></i>
            </button>

            <!-- Filters -->
            <div class="flex items-center gap-6 bg-gray-100 p-1 rounded-2xl border border-black/5 pr-4">
                <div class="flex items-center gap-2 pl-3 border-r border-black/5 mr-1">
                    <label class="relative inline-flex items-center cursor-pointer group">
                        <input type="checkbox" id="ev-toggle" class="sr-only peer" checked
                            onchange="toggleEVSeries(this.checked)">
                        <div
                            class="w-9 h-5 bg-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500">
                        </div>
                        <span
                            class="ml-2 text-[10px] font-bold uppercase tracking-widest text-gray-500 group-hover:text-black transition-colors">EV
                            Line</span>
                    </label>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleChartSeries('ALL')" id="btn-all"
                        class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all bg-black text-white">All</button>
                    <button onclick="toggleChartSeries('UP')" id="btn-up"
                        class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-500 hover:text-black">UP
                        only</button>
                    <button onclick="toggleChartSeries('DOWN')" id="btn-down"
                        class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-500 hover:text-black">DOWN
                        only</button>
                </div>
            </div>
        </div>

        <div id="chart-wrapper" class="p-6 md:p-10 pt-20 md:pt-24 h-full flex flex-col">
            <div id="interactive-chart" class="flex-1" style="min-height: 450px;"></div>
        </div>
    </div>
</div>

<style>
    #chart-container.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        margin: 0;
        border-radius: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
    }

    #chart-container.fullscreen #chart-wrapper {
        padding: 2rem;
        padding-top: 6rem;
        /* Extra space for fixed controls */
        flex: 1;
    }

    #chart-container.fullscreen #interactive-chart {
        flex: 1;
        width: 100% !important;
        height: 100% !important;
    }
</style>

<script>
    // Data setup
    var rawTrades = {{ trades_json| safe }};
    var sortedTrades = [...rawTrades].sort((a, b) => a.timestamp - b.timestamp);

    var priceData = sortedTrades.map(t => ({
        x: t.timestamp * 1000,
        y: t.price / 100
    }));

    // Track running totals for YES (Up) and NO (Down) positions
    var runningYesShares = 0;
    var runningNoShares = 0;
    var lastYesVal = 0;
    var lastNoVal = 0;
    var evTimeline = {};
    var exposureTimeline = {};

    // Micro-jittering setup - увеличенное смещение для видимости всех точек
    var lastTimestamp = 0;
    var jitterOffset = 0;
    var JITTER_STEP = 100; // 100ms между точками с одинаковой меткой

    sortedTrades.forEach(t => {
        // Apply jitter
        if (t.timestamp === lastTimestamp) {
            jitterOffset += JITTER_STEP;
        } else {
            jitterOffset = 0;
            lastTimestamp = t.timestamp;
        }
        t.jitteredTs = (t.timestamp * 1000) + jitterOffset;




        if (t.side === 'Up') {
            if (t.type === 'Buy') runningYesShares += t.shares;
            else runningYesShares -= t.shares;
        } else if (t.side === 'Down') {
            if (t.type === 'Buy') runningNoShares += t.shares;
            else runningNoShares -= t.shares;
        }

        const totalShares = runningYesShares + runningNoShares;
        const imbalance = totalShares > 0 ? (Math.abs(runningYesShares - runningNoShares) / totalShares * 100).toFixed(1) : "0.0";

        exposureTimeline[t.jitteredTs] = {
            yes: runningYesShares,
            no: runningNoShares,
            yesVal: (runningYesShares * (t.side === 'Up' ? t.price : lastYesVal) / 100).toFixed(2),
            noVal: (runningNoShares * (t.side === 'Down' ? t.price : lastNoVal) / 100).toFixed(2),
            imbalance: imbalance
        };

        if (t.side === 'Up') lastYesVal = t.price;
        if (t.side === 'Down') lastNoVal = t.price;
        if (lastYesVal > 0 && lastNoVal > 0) {
            evTimeline[t.jitteredTs] = (lastYesVal + lastNoVal).toFixed(2);
        }
    });

    var upTrades = sortedTrades.filter(t => t.side === 'Up').map(t => ({
        x: t.jitteredTs,
        y: t.price / 100,
        meta: {
            shares: t.shares,
            cost: t.cost,
            side: 'UP',
            type: t.type,
            ev: (evTimeline[t.jitteredTs] / 100).toFixed(2) || 'N/A',
            exposure: exposureTimeline[t.jitteredTs]
        }
    }));

    var downTrades = sortedTrades.filter(t => t.side === 'Down').map(t => ({
        x: t.jitteredTs,
        y: t.price / 100,
        meta: {
            shares: t.shares,
            cost: t.cost,
            side: 'DOWN',
            type: t.type,
            ev: (evTimeline[t.jitteredTs] / 100).toFixed(2) || 'N/A',
            exposure: exposureTimeline[t.jitteredTs]
        }
    }));


    var options = {
        series: [
            {
                name: 'Market Price',
                type: 'line',
                data: priceData
            },
            {
                name: 'UP Trades',
                type: 'scatter',
                data: upTrades
            },
            {
                name: 'DOWN Trades',
                type: 'scatter',
                data: downTrades
            },
            {
                name: 'EV (YES+NO)',
                type: 'line',
                data: sortedTrades.map(t => {
                    const val = evTimeline[t.jitteredTs];
                    if (!val) return null;
                    const decimalVal = (parseFloat(val) / 100).toFixed(2);
                    return {
                        x: t.jitteredTs,
                        y: parseFloat(decimalVal),
                        meta: { side: 'EV', ev: decimalVal }
                    };
                }).filter(p => p !== null)
            }
        ],
        chart: {
            height: 500,
            type: 'line',
            toolbar: { show: false },
            animations: { enabled: true },
            fontFamily: 'inherit'
        },
        colors: ['#000000', '#10B981', '#EF4444', '#F97316'],
        stroke: {
            width: [1, 0, 0, 2],
            curve: ['stepline', 'smooth', 'smooth', 'smooth']
        },
        markers: {
            size: [0, 8, 8, 0],
            strokeWidth: 2,
            strokeColors: '#fff',
            hover: { size: 10 }
        },
        xaxis: {
            type: 'datetime',
            labels: {
                datetimeUTC: false,
                style: { colors: '#9CA3AF', fontSize: '10px' }
            },
            axisBorder: { show: false },
            axisTicks: { show: false }
        },
        yaxis: {
            labels: {
                formatter: (val) => val.toFixed(2),
                style: { colors: '#9CA3AF', fontSize: '10px' }
            }
        },
        grid: {
            borderColor: '#000000',
            strokeDashArray: 0,
            opacity: 0.05,
            padding: { left: 20, right: 20 }
        },
        tooltip: {
            shared: false,
            intersect: true,
            theme: 'light',
            followCursor: true,
            offsetY: 0,
            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                const data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                if (!data) return '';

                if (!data.meta) {
                    return '<div class="p-4 bg-white border border-black rounded-2xl shadow-xl pointer-events-none">' +
                        '<span class="text-[10px] text-gray-400 uppercase block mb-1">Price</span>' +
                        '<span class="text-xl font-thin tracking-tight">' + data.y.toFixed(2) + '</span>' +
                        '</div>';
                }

                const meta = data.meta;
                const date = new Date(data.x);
                const yektTime = date.toLocaleString('ru-RU', {
                    timeZone: 'Asia/Yekaterinburg',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });

                // Dedicated EV Tooltip Case
                if (meta.side === 'EV') {
                    return `<div class="p-5 bg-white border border-black rounded-3xl shadow-2xl min-w-[220px] pointer-events-none">
                            <div class="flex justify-between items-start mb-4">
                                <span class="px-2 py-1 rounded-lg text-[9px] font-bold uppercase tracking-widest bg-gray-50 text-gray-600">EV Indicator</span>
                                <span class="text-[10px] text-gray-400 font-mono text-right leading-tight">${yektTime}</span>
                            </div>
                            <div class="space-y-1">
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest block mb-0.5 font-light">Price Efficiency</span>
                                <div class="text-2xl font-light tracking-tighter text-black">EV: ${meta.ev}</div>
                            </div>
                        </div>`;
                }

                // Standard Trade Tooltip Case
                return `<div class="p-5 bg-white border border-black rounded-3xl shadow-2xl min-w-[220px] pointer-events-none">
                        <div class="flex justify-between items-start mb-4 gap-4">
                            <span class="px-2 py-1 rounded-lg text-[9px] font-bold uppercase tracking-widest ${meta.side === 'UP' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}">${meta.side} ${meta.type}</span>
                            <span class="text-[10px] text-gray-400 font-mono text-right leading-tight">${yektTime}</span>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest block mb-0.5 font-light">Position Size</span>
                                <div class="text-lg font-light text-black tracking-tight">${meta.shares.toLocaleString()} Shares</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-3 border-t border-black/5">
                                <div>
                                    <span class="text-[9px] text-gray-400 uppercase tracking-widest block mb-0.5 font-light">Exec Price</span>
                                    <span class="text-base font-light text-black">${data.y.toFixed(2)}</span>
                                </div>
                                <div>
                                    <span class="text-[9px] text-gray-400 uppercase tracking-widest block mb-0.5 font-light">Total Cost</span>
                                    <span class="text-base font-light text-black">$${meta.cost.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <!-- Portfolio Exposure Block -->
                            <div class="pt-3 border-t border-black/5">
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest block mb-2 font-light">Portfolio Exposure</span>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex flex-col gap-1">
                                        <span class="text-[8px] text-green-600 font-bold uppercase tracking-wider">YES Side</span>
                                        <div class="flex flex-col leading-none">
                                            <span class="text-base font-light text-black">${meta.exposure.yes.toLocaleString()}</span>
                                            <span class="text-base font-light text-black mt-0.5">$${meta.exposure.yesVal}</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <span class="text-[8px] text-red-600 font-bold uppercase tracking-wider">NO Side</span>
                                        <div class="flex flex-col leading-none">
                                            <span class="text-base font-light text-black">${meta.exposure.no.toLocaleString()}</span>
                                            <span class="text-base font-light text-black mt-0.5">$${meta.exposure.noVal}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Share Imbalance Row -->
                            <div class="pt-3 border-t border-black/5 flex justify-between items-center">
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest block font-light">Share Imbalance</span>
                                <div class="text-base font-light text-black">${meta.exposure.imbalance}%</div>
                            </div>

                            <!-- EV Indicator Row -->
                            <div class="pt-3 border-t border-black/5 flex justify-between items-center">
                                <span class="text-[9px] text-gray-400 uppercase tracking-widest block font-light">EV Indicator</span>
                                <div class="text-base font-light text-black">EV: ${meta.ev}</div>
                            </div>
                        </div>
                    </div>`;
            }
        },
        legend: { show: false }
    };

    var chart = new ApexCharts(document.querySelector("#interactive-chart"), options);
    chart.render();

    window.toggleChartSeries = function (type) {
        ['all', 'up', 'down'].forEach(id => {
            const el = document.getElementById('btn-' + id);
            if (el) el.className = "px-4 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all text-gray-500 hover:text-black";
        });
        const activeEl = document.getElementById('btn-' + type.toLowerCase());
        if (activeEl) activeEl.className = "px-4 py-2 text-[10px] font-bold uppercase tracking-widest rounded-xl transition-all bg-black text-white";

        if (type === 'ALL') {
            chart.showSeries('UP Trades');
            chart.showSeries('DOWN Trades');
        } else if (type === 'UP') {
            chart.showSeries('UP Trades');
            chart.hideSeries('DOWN Trades');
        } else {
            chart.hideSeries('UP Trades');
            chart.showSeries('DOWN Trades');
        }
    };

    window.toggleEVSeries = function (isChecked) {
        if (isChecked) {
            chart.showSeries('EV (YES+NO)');
        } else {
            chart.hideSeries('EV (YES+NO)');
        }
    };

    window.toggleFullscreen = function () {
        const container = document.getElementById('chart-container');
        const maxIcon = document.getElementById('maximize-icon');
        const minIcon = document.getElementById('minimize-icon');
        const isFullscreen = container.classList.toggle('fullscreen');

        // Update icons
        if (maxIcon && minIcon) {
            maxIcon.classList.toggle('hidden', isFullscreen);
            minIcon.classList.toggle('hidden', !isFullscreen);
        }

        // Lock/Unlock body scroll
        document.body.style.overflow = isFullscreen ? 'hidden' : '';

        // Let chart resize to new dimensions
        setTimeout(() => {
            if (chart) {
                chart.updateOptions({
                    chart: {
                        height: isFullscreen ? '100%' : 500
                    }
                }, false, true);
            }
        }, 100);
    };

    if (window.lucide) window.lucide.createIcons();
</script>