{% extends "base.html" %}

{% block title %}Proxy Wallet Analyzer - PolyEYE{% endblock %}

{% block extra_head %}
<!-- ApexCharts для графиков -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<main class="max-w-[1600px] mx-auto px-4 md:px-8 mt-8 pb-20" x-data="{
        currentStep: 1,
        completedSteps: [1],
        marketTitle: 'Market',

        init() {
            window.addEventListener('market-selected', (e) => {
                this.marketSelected(e.detail.title);
            });
            window.addEventListener('trades-loaded', () => {
                this.tradesLoaded();
            });
        },

        isActive(step) {
            return this.currentStep === step;
        },

        isCompleted(step) {
            return this.completedSteps.includes(step);
        },

        canNav(step) {
            return this.isCompleted(step) || this.currentStep === step || step < this.currentStep;
        },

        setStep(step) {
            if (this.canNav(step)) {
                this.currentStep = step;
            }
        },

        completeStep(step) {
            if (!this.completedSteps.includes(step)) {
                this.completedSteps.push(step);
            }
            const next = step + 1;
            if (next <= 3) {
                this.currentStep = next;
                if (!this.completedSteps.includes(next)) {
                    this.completedSteps.push(next);
                }
            }
        },

        marketSelected(title) {
            this.marketTitle = title;
            this.completeStep(1);
        },

        tradesLoaded() {
            this.completeStep(2);
        },

        resolvedSet() {
            this.completeStep(3);
        }
    }">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Left Sidebar (Step Navigator) -->
        <aside class="lg:col-span-3">
            <div class="bg-white rounded-[40px] p-4 border border-black sticky top-24">
                <div class="flex flex-col gap-2">
                    <!-- Step 1 -->
                    <button @click="setStep(1)" :disabled="!canNav(1)"
                        class="relative flex items-center gap-4 p-4 rounded-[32px] transition-all duration-500 group overflow-hidden border border-transparent"
                        :class="isActive(1) ? 'bg-black text-white' : 'text-gray-400 hover:border-black hover:text-black ' + (!canNav(1) ? 'opacity-50 cursor-not-allowed' : '')">
                        <div class="h-10 w-10 rounded-full flex items-center justify-center transition-colors duration-300"
                            :class="isActive(1) ? 'bg-white/10 text-white' : (isCompleted(1) ? 'bg-gray-100 text-black' : 'bg-gray-50 text-gray-400 group-hover:bg-white group-hover:text-black')">
                            <i data-lucide="search" width="18" class="stroke-current"></i>
                        </div>
                        <div class="text-left">
                            <span class="block text-[10px] font-light uppercase tracking-wider mb-0.5"
                                :class="isActive(1) ? 'text-gray-400' : 'text-gray-400'">Step 01</span>
                            <span class="block text-sm font-light uppercase tracking-wide"
                                :class="isActive(1) ? 'text-white' : 'text-gray-500 group-hover:text-black'">Search</span>
                        </div>
                    </button>

                    <!-- Step 2 -->
                    <button @click="setStep(2)" :disabled="!canNav(2)"
                        class="relative flex items-center gap-4 p-4 rounded-[32px] transition-all duration-500 group overflow-hidden border border-transparent"
                        :class="isActive(2) ? 'bg-black text-white' : 'text-gray-400 hover:border-black hover:text-black ' + (!canNav(2) ? 'opacity-50 cursor-not-allowed' : '')">
                        <div class="h-10 w-10 rounded-full flex items-center justify-center transition-colors duration-300"
                            :class="isActive(2) ? 'bg-white/10 text-white' : (isCompleted(2) ? 'bg-gray-100 text-black' : 'bg-gray-50 text-gray-400 group-hover:bg-white group-hover:text-black')">
                            <i data-lucide="list-filter" width="18" class="stroke-current"></i>
                        </div>
                        <div class="text-left">
                            <span class="block text-[10px] font-light uppercase tracking-wider mb-0.5"
                                :class="isActive(2) ? 'text-gray-400' : 'text-gray-400'">Step 02</span>
                            <span class="block text-sm font-light uppercase tracking-wide"
                                :class="isActive(2) ? 'text-white' : 'text-gray-500 group-hover:text-black'">Load
                                Data</span>
                        </div>
                    </button>

                    <!-- Step 3 -->
                    <button @click="setStep(3)" :disabled="!canNav(3)"
                        class="relative flex items-center gap-4 p-4 rounded-[32px] transition-all duration-500 group overflow-hidden border border-transparent"
                        :class="isActive(3) ? 'bg-black text-white' : 'text-gray-400 hover:border-black hover:text-black ' + (!canNav(3) ? 'opacity-50 cursor-not-allowed' : '')">
                        <div class="h-10 w-10 rounded-full flex items-center justify-center transition-colors duration-300"
                            :class="isActive(3) ? 'bg-white/10 text-white' : (isCompleted(3) ? 'bg-gray-100 text-black' : 'bg-gray-50 text-gray-400 group-hover:bg-white group-hover:text-black')">
                            <i data-lucide="bar-chart-3" width="18" class="stroke-current"></i>
                        </div>
                        <div class="text-left">
                            <span class="block text-[10px] font-light uppercase tracking-wider mb-0.5"
                                :class="isActive(3) ? 'text-gray-400' : 'text-gray-400'">Step 03</span>
                            <span class="block text-sm font-light uppercase tracking-wide"
                                :class="isActive(3) ? 'text-white' : 'text-gray-500 group-hover:text-black'">Analysis</span>
                        </div>
                    </button>
                </div>

                <div class="mt-8 p-6 bg-[#F5F5F7] rounded-[32px] text-center border border-transparent">
                    <span class="text-[10px] font-light uppercase tracking-widest text-gray-400">xDaimon</span>
                </div>
            </div>
        </aside>

        <!-- Right Content Area -->
        <section class="lg:col-span-9">
            {% block proxy_content %}{% endblock %}
        </section>
    </div>
</main>

{% block proxy_scripts %}{% endblock %}
{% endblock %}

{% block extra_scripts %}
<script>
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        lucide.createIcons();

        if (evt.detail.target.id === 'search-results') {
            const radios = document.querySelectorAll('input[name="selected_market"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function () {
                    let cidInput = document.getElementById('condition-id-input');
                    if (cidInput) cidInput.value = this.value;
                    let title = this.dataset.title || "Market";
                    window.dispatchEvent(new CustomEvent('market-selected', { detail: { title } }));
                });
            });
        }

        if (evt.detail.target.id === 'trades-result') {
            if (evt.detail.target.innerHTML.includes('Success') || evt.detail.target.innerHTML.includes('✓')) {
                window.dispatchEvent(new CustomEvent('trades-loaded'));
                setTimeout(() => {
                    htmx.trigger('#generate-btn', 'click');
                }, 100);
            }
        }
    });
</script>
{% endblock %}